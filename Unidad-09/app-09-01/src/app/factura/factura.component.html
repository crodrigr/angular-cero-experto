<form #facturaForm="ngForm" novalidate (ngSubmit)="create(facturaForm)" class="needs-validation" [class.was-validated]="facturaForm.submitted">
  <!-- Cliente -->
  <div class="mb-3 row" *ngIf="factura.cliente">
    <label for="cliente" class="col-sm-2 col-form-label">Cliente</label>
    <div class="col-sm-6">
      <input type="text" name="cliente" class="form-control" [value]="factura.cliente.nombre + ' ' + factura.cliente.apellido" disabled>
    </div>
  </div>

  <!-- Descripción -->
  <div class="mb-3 row">
    <label for="descripcion" class="col-sm-2 col-form-label">Descripción</label>
    <div class="col-sm-6">
      <input
        type="text"
        name="descripcion"
        id="descripcion"
        [(ngModel)]="factura.descripcion"
        class="form-control"
        required
        #descripcion="ngModel"
        [class.is-invalid]="descripcion.invalid && (descripcion.touched || facturaForm.submitted)">
      <div class="invalid-feedback">
        La descripción es requerida.
      </div>
    </div>
  </div>

  <!-- Observación -->
  <div class="mb-3 row">
    <label for="observacion" class="col-sm-2 col-form-label">Observación</label>
    <div class="col-sm-6">
      <textarea
        name="observacion"
        id="observacion"
        [(ngModel)]="factura.observacion"
        class="form-control"></textarea>
    </div>
  </div>

  <!-- Autocomplete Productos -->
  <div class="mb-3 row">
    <div class="col-sm-6">
      <mat-form-field class="w-100">
        <input
          type="text"
          placeholder="Añadir producto"
          aria-label="Productos"
          matInput
          [formControl]="autocompleteControl"
          [matAutocomplete]="auto">
        <mat-autocomplete
          #auto="matAutocomplete"
          [displayWith]="mostrarNombre"
          (optionSelected)="seleccionarProducto($event.option.value)">
          <mat-option *ngFor="let producto of productosFiltrados | async" [value]="producto">
            {{ producto.nombre }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      <div class="alert alert-danger mt-2" *ngIf="autocompleteControl.invalid && facturaForm.submitted">
        La factura no puede estar vacía!
      </div>
    </div>
  </div>

  <!-- Tabla de productos -->
  <div *ngIf="factura.items.length === 0" class="alert alert-info my-4">
    No hay líneas asignadas para la factura. Debe agregar al menos una!
  </div>

  <table class="table table-striped table-hover table-sm" *ngIf="factura.items.length > 0">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Total</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of factura.items">
        <td>{{ item.producto.nombre }}</td>
        <td>{{ item.producto.precio | currency: 'COP':'symbol' }}</td>
        <td>
          <input
            type="number"
            [value]="item.cantidad"
            min="1"
            class="form-control form-control-sm w-50"
            (change)="actualizarCantidad(item.producto.id, $event)">
        </td>
        <td>{{ item.calcularImporte() | currency: 'COP':'symbol' }}</td>
        <td>
          <button type="button" class="btn btn-danger btn-sm" (click)="eliminarItemFactura(item.producto.id)">x</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Gran total -->
  <div class="my-3" *ngIf="factura.items.length > 0">
    <h5 class="text-end">Gran Total:
      <span>{{ factura.calcularGranTotal() | currency: 'COP':'symbol' }}</span>
    </h5>
  </div>

  <!-- Botón de envío -->
  <div class="mb-3 row">
    <div class="col-sm-6">
      <input type="submit" value="Crear Factura" class="btn btn-secondary">
    </div>
  </div>
</form>
